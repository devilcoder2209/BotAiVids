{% extends 'admin/model/list.html' %}

{% block list_table %}
<div class="model-list">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">
            <i class="fas fa-{{ 'users' if admin_view.model.__name__ == 'User' else 'video' }}"></i>
            {{ admin_view.model.__name__ }} Management
        </h3>
        <div class="model-actions">
            {% if admin_view.can_create %}
            <a href="{{ get_url('.create_view', url=return_url) }}" class="btn btn-success btn-sm">
                <i class="fas fa-plus"></i> New {{ admin_view.model.__name__ }}
            </a>
            {% endif %}
        </div>
    </div>
    
    {% if admin_view.can_delete %}
    <form method="POST" action="{{ get_url('.action_view') }}" id="action-form">
        {{ action_form.hidden_tag() if action_form }}
    {% endif %}

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    {% if actions %}
                    <th class="list-checkbox-column">
                        <input type="checkbox" name="rowtoggle" class="action-rowtoggle" title="Select all records" />
                    </th>
                    {% endif %}
                    {% for c, name in list_columns %}
                    <th class="column-header">
                        {% if admin_view.is_sortable(c) %}
                        <a href="{{ sort_url(c) }}" title="Sort by {{ name }}">
                            {{ name }}
                            {% if sort_column == c %}
                                {% if sort_desc %}
                                    <i class="fas fa-sort-down"></i>
                                {% else %}
                                    <i class="fas fa-sort-up"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-sort"></i>
                            {% endif %}
                        </a>
                        {% else %}
                        {{ name }}
                        {% endif %}
                    </th>
                    {% endfor %}
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    {% if actions %}
                    <td class="list-checkbox-column">
                        <input type="checkbox" name="rowid" class="action-checkbox" value="{{ get_pk_value(row) }}" title="Select record" />
                    </td>
                    {% endif %}
                    {% for c, name in list_columns %}
                    <td>
                        {% if admin_view.is_editable(c) %}
                        <a href="{{ get_url('.edit_view', id=get_pk_value(row), url=return_url) }}">
                            {{ get_value(row, c) }}
                        </a>
                        {% else %}
                        {% set value = get_value(row, c) %}
                        {% if c == 'status' %}
                            <span class="badge badge-{{ 'success' if value == 'completed' else 'warning' if value == 'processing' else 'danger' }}">
                                {{ value.title() }}
                            </span>
                        {% elif c == 'is_admin' %}
                            <span class="badge badge-{{ 'primary' if value else 'secondary' }}">
                                {{ 'Admin' if value else 'User' }}
                            </span>
                        {% elif c in ['created_at', 'updated_at'] %}
                            <small class="text-muted">
                                {{ value.strftime('%Y-%m-%d %H:%M') if value else 'N/A' }}
                            </small>
                        {% elif c == 'cloudinary_url' and value %}
                            <a href="{{ value }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt"></i> View
                            </a>
                        {% elif c == 'description' and value %}
                            <span title="{{ value }}">
                                {{ value[:50] }}{% if value|length > 50 %}...{% endif %}
                            </span>
                        {% else %}
                            {{ value }}
                        {% endif %}
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            {% if admin_view.can_edit %}
                            <a href="{{ get_url('.edit_view', id=get_pk_value(row), url=return_url) }}" 
                               class="btn btn-sm btn-outline-warning" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                            {% if admin_view.can_view_details %}
                            <a href="{{ get_url('.details_view', id=get_pk_value(row), url=return_url) }}" 
                               class="btn btn-sm btn-outline-info" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% endif %}
                            {% if admin_view.can_delete %}
                            <a href="javascript:void(0)" 
                               onclick="if(confirm('Are you sure you want to delete this record?')) { window.location.href='{{ get_url('.delete_view', id=get_pk_value(row), url=return_url) }}'; }"
                               class="btn btn-sm btn-outline-danger" title="Delete">
                                <i class="fas fa-trash"></i>
                            </a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="{{ list_columns|length + 2 }}" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        No {{ admin_view.model.__name__.lower() }}s found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if admin_view.can_delete %}
    <div class="mt-3">
        {% if actions %}
        <div class="form-group">
            <label for="action">With selected:</label>
            <select name="action" id="action" class="form-control d-inline-block w-auto mx-2">
                <option value="">Choose action</option>
                {% for action_name, action_title in actions %}
                <option value="{{ action_name }}">{{ action_title }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-danger btn-sm">
                <i class="fas fa-play"></i> Execute
            </button>
        </div>
        {% endif %}
    </div>
    </form>
    {% endif %}
    
    {{ lib.render_pagination() }}
</div>

<script>
// Enhanced table interactions
document.addEventListener('DOMContentLoaded', function() {
    // Row toggle functionality
    const masterToggle = document.querySelector('.action-rowtoggle');
    const rowCheckboxes = document.querySelectorAll('.action-checkbox');
    
    if (masterToggle) {
        masterToggle.addEventListener('change', function() {
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
    }
    
    // Update master toggle when individual checkboxes change
    rowCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checkedCount = document.querySelectorAll('.action-checkbox:checked').length;
            masterToggle.checked = checkedCount === rowCheckboxes.length;
            masterToggle.indeterminate = checkedCount > 0 && checkedCount < rowCheckboxes.length;
        });
    });
    
    // Confirm bulk actions
    const actionForm = document.getElementById('action-form');
    if (actionForm) {
        actionForm.addEventListener('submit', function(e) {
            const action = document.getElementById('action').value;
            const checkedBoxes = document.querySelectorAll('.action-checkbox:checked');
            
            if (!action) {
                e.preventDefault();
                alert('Please select an action');
                return;
            }
            
            if (checkedBoxes.length === 0) {
                e.preventDefault();
                alert('Please select at least one record');
                return;
            }
            
            if (action === 'delete' && !confirm(`Are you sure you want to delete ${checkedBoxes.length} record(s)?`)) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
